{"title":"$:/plugins/linonetwo/nodejs-webcatalog-git-sync","name":"NodeJS Wiki WebCatalog Github Sync","description":"Use WebCatalog's NodeJS API to sync data to git on the cloud","author":"LinOnetwo","core-version":">=5.1.22","plugin-type":"plugin","version":"0.0.1","list":"readme","dependents":"","type":"application/json","text":"{\n    \"tiddlers\": {\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/PageControlButton\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/PageControlButton\",\n            \"tags\": \"$:/tags/PageControls\",\n            \"type\": \"text/vnd.tiddlywiki\",\n            \"caption\": \"{{$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg}} 备份本地Git\",\n            \"description\": \"显示本地笔记是否同步备份到Github，点击可同步\",\n            \"text\": \"<$nodejs-webcatalog-git-sync />\\n\"\n        },\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/button.js\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/button.js\",\n            \"text\": \"/*\\\\\\nShow local git state and sync to git on click.\\nRequires you are using WebCatalog, and have install the \\\"Inject JS\\\" API with access to NodeJS and Electron API).\\n\\n\\\\*/\\n(function () {\\n  /*jslint node: true, browser: true */\\n  /*global $tw: true */\\n  'use strict';\\n\\n  const Widget = require('$:/core/modules/widgets/widget.js').widget;\\n\\n  class NodeJSWebCatalogGitSyncWidget extends Widget {\\n    /**\\n     * Lifecycle method: call this.initialise and super\\n     */\\n    constructor(parseTreeNode, options) {\\n      super(parseTreeNode, options);\\n      this.initialise(parseTreeNode, options);\\n      this.state = {\\n        needSetUp: false, // need to setup WebCatalog, or just API missing\\n        interval: 3000, // check interval\\n        count: 0, // things need to commit\\n        unsync: false, // need to push to github\\n        syncing: false, // a sync is in progress\\n      };\\n      this.checkInLoop();\\n    }\\n\\n    /**\\n     * Lifecycle method: Render this widget into the DOM\\n     */\\n    render(parent, nextSibling) {\\n      // boilerplate\\n      this.parentDomNode = parent;\\n      this.computeAttributes();\\n\\n      // DOM\\n      const importButton = this.document.createElement('button');\\n      importButton.className = 'tc-btn-invisible tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync ';\\n      importButton.onclick = this.onSyncButtonClick.bind(this);\\n\\n      // set icon\\n      if (this.state.needSetUp) {\\n        // all commit and sync to cloud\\n        importButton.className += 'git-sync';\\n        importButton.disabled = true;\\n        // tooltip\\n        const label = '需要配置WebCatalog';\\n        importButton.title = label;\\n        importButton['aria-label'] = label;\\n        // icon\\n        importButton.innerHTML = $tw.wiki.getTiddlerText(\\n          '$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg'\\n        );\\n      } else if (this.state.syncing) {\\n        // all commit and sync to cloud\\n        importButton.className += 'git-sync syncing';\\n        importButton.disabled = true;\\n        // tooltip\\n        const label = '正在同步到云端';\\n        importButton.title = label;\\n        importButton['aria-label'] = label;\\n        // icon\\n        importButton.innerHTML = $tw.wiki.getTiddlerText(\\n          '$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg'\\n        );\\n      } else if (this.state.count === 0 && !this.state.unsync) {\\n        // all commit and sync to cloud\\n        importButton.className += 'git-sync';\\n        importButton.disabled = true;\\n        // tooltip\\n        const label = '已完全同步到云端';\\n        importButton.title = label;\\n        importButton['aria-label'] = label;\\n        // icon\\n        importButton.innerHTML = $tw.wiki.getTiddlerText(\\n          '$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg'\\n        );\\n      } else if (this.state.count === 0 && this.state.unsync) {\\n        // some commit need to sync to the cloud\\n        importButton.className += 'git-pull-request';\\n        // tooltip\\n        const label = '待推送到云端';\\n        importButton.title = label;\\n        importButton['aria-label'] = label;\\n        // icon\\n        importButton.innerHTML = $tw.wiki.getTiddlerText(\\n          '$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-pull-request.svg'\\n        );\\n      } else {\\n        // some need to commit, and not sync to cloud yet\\n        importButton.className += 'git-pull-request';\\n        // tooltip\\n        const label = `${this.state.count} 个文件待提交和推送`;\\n        importButton.title = label;\\n        importButton['aria-label'] = label;\\n        // icon\\n        const iconSVG = $tw.wiki.getTiddlerText(\\n          '$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-pull-request.svg'\\n        );\\n        // add count indicator badge\\n        const countIndicator = `<span>${this.state.count}</span>`;\\n        importButton.innerHTML = `<span>${iconSVG}${countIndicator}</span>`;\\n      }\\n\\n      // boilerplate\\n      parent.insertBefore(importButton, nextSibling);\\n      this.domNodes.push(importButton);\\n    }\\n\\n    /**\\n     * Event listener of button\\n     */\\n    async onSyncButtonClick() {\\n      if (!this.state.syncing) {\\n        this.state.syncing = true;\\n        this.refreshSelf();\\n        try {\\n          const publicRepoState = await window.wiki.isUnsync(window.wiki.wikiPath.tiddlyWikiRepo);\\n          const privateRepoState = await window.wiki.isUnsync(window.wiki.wikiPath.privateTiddlyWikiRepo);\\n          if (publicRepoState) {\\n            await window.wiki.sync(window.wiki.wikiPath.tiddlyWikiRepo);\\n          }\\n          if (privateRepoState) {\\n            await window.wiki.sync(window.wiki.wikiPath.privateTiddlyWikiRepo);\\n          }\\n        } catch (error) {\\n          console.error('NodeJSWebCatalogGitSyncWidget: Error syncing', error);\\n        }\\n        this.state.syncing = false;\\n        this.refreshSelf();\\n      }\\n    }\\n\\n    /**\\n     * Check state every a few time\\n     */\\n    async checkInLoop() {\\n      // check if API from WebCatalog is available, first time it is Server Side Rendening so window.xxx from the electron ContextBridge will be missing\\n      // if (typeof window?.wiki?.isUnsync !== 'function' || typeof window?.wiki?.sync !== 'function') {\\n      if (!window.wiki || typeof window.wiki.isUnsync !== 'function' || typeof window.wiki.sync !== 'function') {\\n        this.state.needSetUp = true;\\n      } else {\\n        this.state.needSetUp = false;\\n        this.checkGitState();\\n      }\\n      setTimeout(() => {\\n        this.checkInLoop();\\n      }, this.state.interval);\\n    }\\n\\n    /**\\n     *  Check repo git sync state and count of uncommit things\\n     */\\n    async checkGitState() {\\n      // { unsync: boolean, uncommit: number } | boolean\\n      const publicRepoState = await window.wiki.isUnsync(window.wiki.wikiPath.tiddlyWikiRepo);\\n      const privateRepoState = await window.wiki.isUnsync(window.wiki.wikiPath.privateTiddlyWikiRepo);\\n\\n      this.state.count = 0;\\n      this.state.unsync = false;\\n      if (publicRepoState) {\\n        this.state.count += publicRepoState.uncommit;\\n        this.state.unsync |= publicRepoState.unsync;\\n      }\\n      if (privateRepoState) {\\n        this.state.count += privateRepoState.uncommit;\\n        this.state.unsync |= privateRepoState.unsync;\\n      }\\n\\n      return this.refreshSelf(); // method from super class, this is like React forceUpdate, we use it because it is not fully reactive on this.state change\\n    }\\n  }\\n\\n  exports['nodejs-webcatalog-git-sync'] = NodeJSWebCatalogGitSyncWidget;\\n})();\\n\",\n            \"type\": \"application/javascript\",\n            \"module-type\": \"widget\"\n        },\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-pull-request.svg\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-pull-request.svg\",\n            \"text\": \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" class=\\\"tc-image-button\\\" width=\\\"22\\\" height=\\\"22\\\" viewBox=\\\"0 0 22 22\\\" stroke-width=\\\"2\\\" stroke=\\\"currentColor\\\" fill=\\\"none\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\">\\n  <path stroke=\\\"none\\\" d=\\\"M0 0h24v24H0z\\\"/>\\n  <circle cx=\\\"6\\\" cy=\\\"18\\\" r=\\\"2\\\"/>\\n  <circle cx=\\\"6\\\" cy=\\\"6\\\" r=\\\"2\\\"/>\\n  <circle cx=\\\"18\\\" cy=\\\"18\\\" r=\\\"2\\\"/>\\n  <line x1=\\\"6\\\" y1=\\\"8\\\" x2=\\\"6\\\" y2=\\\"16\\\"/>\\n  <path d=\\\"M11 6h5a2 2 0 0 1 2 2v8\\\"/>\\n  <polyline points=\\\"14 9 11 6 14 3\\\"/>\\n</svg>\",\n            \"type\": \"text/vnd.tiddlywiki\"\n        },\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/icons/git-sync.svg\",\n            \"text\": \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" class=\\\"tc-image-button\\\" width=\\\"22\\\" height=\\\"22\\\" viewBox=\\\"0 0 22 22\\\" stroke-width=\\\"2\\\" stroke=\\\"currentColor\\\" fill=\\\"none\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\">\\n  <path stroke=\\\"none\\\" d=\\\"M0 0h24v24H0z\\\"/>\\n  <circle cx=\\\"6\\\" cy=\\\"6\\\" r=\\\"2\\\"/>\\n  <circle cx=\\\"18\\\" cy=\\\"18\\\" r=\\\"2\\\"/>\\n  <path d=\\\"M11 6h5a2 2 0 0 1 2 2v8\\\"/>\\n  <polyline points=\\\"14 9 11 6 14 3\\\"/>\\n  <path d=\\\"M13 18h-5a2 2 0 0 1 -2 -2v-8\\\"/>\\n  <polyline points=\\\"10 15 13 18 10 21\\\"/>\\n</svg>\",\n            \"type\": \"text/vnd.tiddlywiki\"\n        },\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/readme\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/readme\",\n            \"type\": \"text/vnd.tiddlywiki\",\n            \"text\": \"!! 功能\\n\\n[[WebCatalog|https://webcatalogapp.com/]] 除了[[能将 TiddlyWiki 包装成桌面应用|https://onetwo.ren/%E7%94%A8tiddlywiki%E6%9B%BF%E4%BB%A3notion%E5%92%8Cevernote%E7%AE%A1%E7%90%86%E7%9F%A5%E8%AF%86/]]以外，还提供了自定义 API 并暴露给网页的功能，让我们可以在 Wiki 网页里使用一些高级功能。\\n\\n本插件利用暴露的自定义 API 实现：\\n\\n# 查看本地 NodeJS 版 TiddlyWiki 是否完全与 Github 备份云同步了\\n# 一键同步本地和云端\\n\"\n        },\n        \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/style.css\": {\n            \"title\": \"$:/plugins/linonetwo/nodejs-webcatalog-git-sync/style.css\",\n            \"text\": \"button.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync.git-sync {\\n  cursor: not-allowed;\\n}\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync.git-pull-request > span > span {\\n  position: absolute;\\n  font-size: 0.6em;\\n  margin-left: -1em;\\n  background: dimgrey;\\n  color: white;\\n  border-radius: 9999px;\\n  padding-left: 0.2em;\\n  padding-right: 0.2em;\\n  line-height: 1.3em;\\n  opacity: 0.5;\\n}\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync > span > svg,\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync > svg {\\n  fill: none;\\n  color: #aaa;\\n}\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync > span > svg:hover,\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync > svg:hover {\\n  fill: none;\\n  color: #444;\\n}\\n\\n@keyframes rotation {\\n  from {\\n      transform: rotate(0deg);\\n  }\\n  to {\\n      transform: rotate(359deg);\\n  }\\n}\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync.syncing > span > svg,\\nbutton.tc-btn-invisible.tc-btn-plugins-linonetwo-nodejs-webcatalog-git-sync.syncing > svg {\\n  animation: rotation 2s infinite linear;\\n}\\n\",\n            \"tags\": \"$:/tags/Stylesheet\",\n            \"type\": \"text/css\"\n        }\n    }\n}"}